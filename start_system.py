#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç”µè´¹ç›‘æ§ç³»ç»Ÿå¯åŠ¨è„šæœ¬
ä¸€é”®å¯åŠ¨WebæœåŠ¡å™¨å’Œè‡ªåŠ¨æ›´æ–°æœåŠ¡
"""

import subprocess
import threading
import time
import os
import signal
import sys

class SystemManager:
    def __init__(self):
        self.processes = []
        self.script_dir = os.path.dirname(os.path.abspath(__file__))
        
    def start_web_server(self):
        """
        å¯åŠ¨WebæœåŠ¡å™¨
        """
        try:
            print("ğŸŒ å¯åŠ¨WebæœåŠ¡å™¨...")
            process = subprocess.Popen(
                ['python3', '-m', 'http.server', '8000'],
                cwd=self.script_dir
            )
            self.processes.append(process)
            print("âœ… WebæœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:8000")
            return process
        except Exception as e:
            print(f"âŒ WebæœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}")
            return None
    
    def start_auto_updater(self):
        """
        å¯åŠ¨è‡ªåŠ¨æ›´æ–°æœåŠ¡
        """
        try:
            print("ğŸ”„ å¯åŠ¨è‡ªåŠ¨æ›´æ–°æœåŠ¡...")
            process = subprocess.Popen(
                ['python3', 'auto_update.py'],
                cwd=self.script_dir
            )
            self.processes.append(process)
            print("âœ… è‡ªåŠ¨æ›´æ–°æœåŠ¡å·²å¯åŠ¨")
            return process
        except Exception as e:
            print(f"âŒ è‡ªåŠ¨æ›´æ–°æœåŠ¡å¯åŠ¨å¤±è´¥: {e}")
            return None
    
    def stop_all_processes(self):
        """
        åœæ­¢æ‰€æœ‰è¿›ç¨‹
        """
        print("\nğŸ›‘ æ­£åœ¨åœæ­¢æ‰€æœ‰æœåŠ¡...")
        for process in self.processes:
            try:
                process.terminate()
                process.wait(timeout=5)
            except subprocess.TimeoutExpired:
                process.kill()
            except Exception as e:
                print(f"åœæ­¢è¿›ç¨‹æ—¶å‡ºé”™: {e}")
        print("âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢")
    
    def signal_handler(self, signum, frame):
        """
        ä¿¡å·å¤„ç†å™¨
        """
        self.stop_all_processes()
        sys.exit(0)
    
    def start_system(self):
        """
        å¯åŠ¨æ•´ä¸ªç³»ç»Ÿ
        """
        print("ğŸš€ ç”µè´¹ç›‘æ§ç³»ç»Ÿå¯åŠ¨ä¸­...")
        print("=" * 50)
        
        # æ³¨å†Œä¿¡å·å¤„ç†å™¨
        signal.signal(signal.SIGINT, self.signal_handler)
        signal.signal(signal.SIGTERM, self.signal_handler)
        
        # å¯åŠ¨WebæœåŠ¡å™¨
        web_process = self.start_web_server()
        if not web_process:
            return
        
        # ç­‰å¾…WebæœåŠ¡å™¨å¯åŠ¨
        time.sleep(2)
        
        # å¯åŠ¨è‡ªåŠ¨æ›´æ–°æœåŠ¡
        updater_process = self.start_auto_updater()
        
        print("\n" + "=" * 50)
        print("ğŸ‰ ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼")
        print("ğŸ“Š è®¿é—®åœ°å€: http://localhost:8000")
        print("ğŸ”„ è‡ªåŠ¨æ›´æ–°: æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡æ•°æ®")
        print("â° å®šæ—¶æ›´æ–°: æ¯å¤©8:00å’Œ22:00")
        print("\næŒ‰ Ctrl+C åœæ­¢ç³»ç»Ÿ")
        print("=" * 50)
        
        try:
            # ä¿æŒä¸»è¿›ç¨‹è¿è¡Œ
            while True:
                time.sleep(1)
                # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
                for i, process in enumerate(self.processes[:]):
                    if process.poll() is not None:
                        print(f"âš ï¸  è¿›ç¨‹ {i+1} å·²é€€å‡º")
                        self.processes.remove(process)
                        
        except KeyboardInterrupt:
            pass
        finally:
            self.stop_all_processes()

def main():
    """
    ä¸»å‡½æ•°
    """
    manager = SystemManager()
    manager.start_system()

if __name__ == "__main__":
    main()